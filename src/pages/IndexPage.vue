<template>
  <q-page padding class="flex justify-center">
	<q-card class="my-card" style="width:90vw; max-width:390px;">
<!--		<q-card-section class="bg-primary text-white">
			<div class="text-h6">‡¥™‡µç‡¥∞‡µÄ ‡¥ì‡µº‡¥°‡¥±‡¥ø‡¥ô‡µç </div>
			<div class="text-subtitle2">Rs 30 ‡¥í‡¥∞‡µÅ ‡¥ï‡¥≤‡¥£‡µç‡¥ü‡¥±‡¥ø‡¥®‡µÅ </div>
		</q-card-section>-->

		<q-card-section class="q-gutter-y-sm">
			<div class="text-caption">‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µç‡¥ï‡µç‡¥ï‡µç ‡¥ï‡¥≤‡¥£‡µç‡¥ü‡µº ‡¥µ‡µá‡¥£‡¥Æ‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ, ‡¥™‡µá‡¥∞‡µÅ‡¥Ç ‡¥´‡µã‡µ∫ ‡¥®‡¥Æ‡µç‡¥™‡¥±‡µÅ‡¥Ç ‡¥§‡¥æ‡¥¥‡µÜ ‡¥ï‡µä‡¥ü‡µÅ‡¥§‡µç‡¥§‡µÅ submit ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï </div>
			<div class="text-caption">‡¥ï‡¥≤‡¥£‡µç‡¥ü‡µº ‡¥í‡¥®‡µç‡¥®‡¥ø‡¥®‡µç 30 ‡¥∞‡µÇ‡¥™. ‡¥ö‡¥æ‡¥µ‡¥ï‡µç‡¥ï‡¥æ‡¥ü‡µç ‡¥Æ‡µá‡¥ñ‡¥≤‡¥Ø‡¥ø‡µΩ ‡¥´‡¥ø‡¥±‡µã‡¥∏‡µç ‡¥Ø‡µÅ‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥®‡µá‡¥∞‡¥ø‡¥ü‡µç‡¥ü‡µç ‡¥ï‡¥£‡µç‡¥ü‡µÅ ‡¥ï‡µà‡¥™‡µç‡¥™‡¥±‡µç‡¥±‡¥æ‡µª ‡¥∏‡µó‡¥ï‡¥∞‡µç‡¥Ø‡¥Ç ‡¥â‡¥≥‡µç‡¥≥‡¥µ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Æ‡¥æ‡¥£‡µç ‡¥à ‡¥∏‡µó‡¥ï‡¥∞‡µç‡¥Ø‡¥Ç.. ‡¥Ö‡¥∏‡µó‡¥ï‡¥∞‡µç‡¥Ø‡¥Ç ‡¥®‡µá‡¥∞‡¥ø‡¥ü‡µç‡¥ü‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ, ‡¥®‡µÄ‡¥∞‡µÅ‡¥™‡¥æ‡¥§‡¥ø‡¥ï‡¥Ç ‡¥ï‡µç‡¥∑‡¥Æ ‡¥ö‡µã‡¥¶‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ.. ‡¥§‡¥≤‡µç‡¥ï‡µç‡¥ï‡¥æ‡¥≤‡¥Ç ‡¥µ‡µá‡¥±‡µÜ ‡¥ì‡¥™‡µç‡¥∑‡µª ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡µç‡¥§‡¥§‡µÅ ‡¥ï‡µä‡¥£‡µç‡¥ü‡¥æ‡¥£‡µç ...</div>
			<div class="text-caption">‡¥ï‡¥≤‡¥£‡µç‡¥ü‡µº, ‡¥ú‡¥®‡µÅ‡¥µ‡¥∞‡¥ø ‡¥Æ‡¥æ‡¥∏‡¥Ç ‡¥Ü‡¥¶‡µç‡¥Ø ‡¥Ü‡¥¥‡µç‡¥ö‡¥Ø‡¥ø‡¥≤‡¥æ‡¥ï‡µÅ‡¥Ç ‡¥é‡¥§‡µç‡¥§‡µÅ‡¥ï.. ‡¥™‡µç‡¥∞‡¥ø‡µª‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ, ‡¥ï‡µã‡¥¥‡¥ø‡¥ï‡µç‡¥ï‡µã‡¥ü‡µç ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥é‡¥§‡µç‡¥§‡µá‡¥£‡µç‡¥ü‡¥§‡µÅ‡¥£‡µç‡¥ü‡µç...</div>
			<div class="text-caption"> &nbsp; </div>
			<q-input outlined v-model="person.name" label="‡¥™‡µá‡¥∞‡µç" />
			<q-input outlined v-model="person.phone" label="‡¥´‡µã‡µ∫" />
			<q-input outlined v-model.number="person.quantity" type="number" label="‡¥é‡¥§‡µç‡¥∞ ‡¥é‡¥£‡µç‡¥£‡¥Ç" />
			<q-btn color="primary" label="üëá Submit" @click="addName" />
			<q-inner-loading :showing="loading" />
		</q-card-section>

		<q-separator />

		<q-list separator v-if="Object.keys(bookings).length">
			<q-item>
				<q-item-label header>üëá ‡¥á‡¥§‡µÅ‡¥µ‡¥∞‡µÜ ‡¥¨‡µÅ‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥§‡µç {{ Object.keys(bookings).length }} ‡¥™‡µá‡µº, {{ total }} ‡¥é‡¥£‡µç‡¥£‡¥Ç</q-item-label>
			</q-item>
			<q-item v-for="(booking,id,idx) in bookings" :key="id">
<!--				<q-item-section side class='text-bold'>{{ idx+1 }}</q-item-section>-->
				<q-item-section>
					<q-item-label>{{ booking.name }}</q-item-label>
					<q-item-label caption>{{ booking.phone }}</q-item-label>
				</q-item-section>
        <q-item-section side>
          <q-item-label>
            <q-btn icon="currency_rupee" :color="booking.paid ? 'positive' :'grey-3'" size="md" flat dense round @click="paid(id)" />
            <q-btn icon="done_all" :color="booking.delivered ? 'positive' :'grey-3'" size="md" flat dense round @click="delivered(id)" />
          </q-item-label>
        </q-item-section>
				<q-item-section side>
				  <q-avatar rounded>{{ booking.quantity }}</q-avatar>
				</q-item-section>
				<q-item-section side v-if="booking.delete">
				  <q-btn icon="close" round color="negative" dense @click="deleteName(id)" />
				</q-item-section>
			</q-item>
		</q-list>
    </q-card>
  </q-page>
</template>

<script setup>
	import { db,collection,getDocs,addDoc,deleteDoc,doc,updateDoc } from 'boot/firebase.js';
	import { ref,reactive } from 'vue'
  import { useRoute } from 'vue-router'

  const route = useRoute();
	const admin = route.meta && route.meta.admin
  const bookings = ref({}), loading = ref(false), total = ref(0);
	const person = reactive({ name:'',phone:'',quantity:1 })
	async function setBookings(){
		loading.value = true;
		const qSnaps = await getDocs(collection(db,'history_calendar/orders/bookings'))
		qSnaps.forEach(qSnap => {
			bookings.value[qSnap.id] = qSnap.data();
      total.value += parseInt(qSnap.get('quantity'))
		})
		loading.value = false;
	}

	setBookings();

	async function addName(){
		if(!person.name || !person.phone) return alert('‡¥™‡µá‡¥∞‡µÅ‡¥Ç ‡¥´‡µã‡µ∫ ‡¥®‡¥Æ‡µç‡¥™‡¥±‡µÅ‡¥Ç ‡¥®‡¥ø‡µº‡¥¨‡¥®‡µç‡¥ß‡¥Æ‡¥æ‡¥£‡µç ‡¥∏‡µÅ‡¥π‡µÉ‡¥§‡µç‡¥§‡µá ');
		loading.value = true;
		const dRef = await addDoc(collection(db, "history_calendar/orders/bookings"), person);
		alert('‡¥®‡¥®‡µç‡¥¶‡¥ø, ‡¥§‡¥æ‡¥ô‡µç‡¥ï‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç ‡¥®‡µã‡¥ü‡µç‡¥ü‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µç.. ‡¥ï‡¥≤‡¥£‡µç‡¥ü‡µº ‡¥â‡¥ü‡µª ‡¥é‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç... ' + (person.quantity*30) + ' ‡¥∞‡µÇ‡¥™ ‡¥ï‡¥∞‡µÅ‡¥§‡¥ø ‡¥µ‡µÜ‡¥ö‡µç‡¥ö‡µã‡¥≥‡µÇ');
		bookings.value[dRef.id] = Object.assign({ delete:true },person)
    total.value += parseInt(person.quantity)
    person.name = ""; person.phone = ""; person.quantity = 1
		loading.value = false;
	}

  async function deleteName(id){
    loading.value = true;
    await deleteDoc(doc(db,'history_calendar/orders/bookings/' + id))
    total.value -= parseInt(bookings.value[id].quantity)
    delete bookings.value[id]
    loading.value = false;
  }

  async function paid(id){
    if(!admin) return;
    loading.value = true;
    let paid = (bookings.value[id].paid = !bookings.value[id].paid)
    await updateDoc(doc(db,'history_calendar/orders/bookings/' + id),{ paid })
    loading.value = false;
  }

  async function delivered(id){
    if(!admin) return;
    loading.value = true;
    let delivered = (bookings.value[id].delivered = !bookings.value[id].delivered)
    await updateDoc(doc(db,'history_calendar/orders/bookings/' + id),{ delivered })
    loading.value = false;
  }
</script>
